var EshopCalculator=function(){var t=this,e={general:{"invalid.period.or.loan.amount":["Invalid amount or period for calculations"]},400:{"no.active.agent":["No active agent"]},404:["not.found","Invalid URL"],500:["internal.error","Internal error"],503:["service.unavailable","Service unavailable"]},a={PERIOD_INFORMATION_TEMPLATE:"([monthly-payment] [currency])"};this.daysBetween=function(t,e){return Math.round(Math.abs((t.getTime()-e.getTime())/864e5))},this.fetchInputParameters=function(t,e,a,i){this.country=t,this.agentId=i,this.url=a;var r=this,n=void 0;return $.ajax({async:!1,type:"POST",url:this.url,data:{action:"wc_iute_get_params"},dataType:"json",success:function(t){t&&(r.debug("Fetched data:"),r.debug(t),n=t)},error:function(t){r.handleErrors(t)}}),n},this.handleErrors=function(t){var a=e[t.status],i=null;if(a)if(400===t.status){var r=a[JSON.parse(t.responseText).property];i=r[r.length-1]}else i=a[a.length-1];else i=t.responseText;i&&this.showError(i)},this.getErrorTranslation=function(t,a){var i=e[t][a];return i[i.length-1]},this.showErrorForLabel=function(t){$("#error").html(this.getErrorTranslation("general",t)),$("#errorDiv").show()},this.showError=function(t){$("#error").html(t),$("#errorDiv").show()},this.hideError=function(){$("#error").html(""),$("#errorDiv").hide()},this.useDebugLog=function(){this.debugEnabled=!0},this.debug=function(t){this.debugEnabled&&console.log(t)},this.initWithLiveAgentInformation=function(t,e,i,r,n){this.country=t,this.currency=e,this.url=i,this.agentId=r,this.calculatorOptions={},this.disabledCustomProducts=n.length>0?n:[],this.getCalculatorOptions(),this.templates=a},this.initWithManualSettings=function(t,e,i,r){this.country=t,this.currency=e,this.calculatorOptions=r,this.initShopFeeDefaultsIfNeeded(i),this.initClientCommissionDefaults(i),this.calculatorParameters={};var n=null;if(Array.isArray(i))n=this.handleManualInputSettingsArray(i);else{var o=this.parseProductSettingsAndAddToCalculationSets(i,0);this.addProductTabs(o,0,!0),this.calculatorParameters[o.customProductId]=o,n=o}this.templates=a,this.setSelectedProduct(n.customProductId),this.updateView(n),this.calculate(n)},this.handleManualInputSettingsArray=function(e){var a=null;if(this.calculatorOptions.combineProducts)a=this.combineInputProducts(e);else{for(var i in e){var r=t.parseProductSettingsAndAddToCalculationSets(e[i],0);this.addProductTabs(r,i,!0),this.calculatorParameters[r.customProductId]=r}a=this.calculatorParameters[e[0].customProductId]}return a},this.combineInputProducts=function(e){var a=e[0],i=t.parseProductSettingsAndAddToCalculationSets(a,0);for(var r in i.customProductId=-1,i.customProductName="Combined product",e)if(0!=r){var n=e[r];if(n.maxPeriod>a.maxPeriod){i.maxPeriod=n.maxPeriod,n.maxAmount>a.maxAmount&&(i.maxAmount=n.maxAmount);var o=this.parsePeriodSettings(n,0);i.amountLimitedPeriodParameters[r]=o}}return this.calculatorParameters[i.customProductId]=i,this.addProductTabs(i,0,!1),i},this.initShopFeeDefaultsIfNeeded=function(t){if(Array.isArray(t))for(var e=0;e<t.length;++e)this.initShopFeeArrayWithDefaultValues(t[e]);else this.initShopFeeArrayWithDefaultValues(t)},this.initShopFeeArrayWithDefaultValues=function(t){if(!t.parameters.SHOP_FEE){for(var e=[],a=t.minPeriod;a<=t.maxPeriod;++a)e.push(0);t.parameters.SHOP_FEE=e}},this.initClientCommissionDefaults=function(t){if(Array.isArray(t))for(var e=0;e<t.length;++e)this.initClientCommissionArrayWithDefaultValues(t[e]);else this.initClientCommissionArrayWithDefaultValues(t)},this.initClientCommissionArrayWithDefaultValues=function(t){if(!t.clientCommission){for(var e=[],a=t.minPeriod;a<=t.maxPeriod;++a)e.push(!1);t.clientCommission=new Object,t.clientCommission.COMMISSION_FOR_CLIENT=e}},this.changeTemplate=function(t,e){this.templates[t]=e},this.processTemplate=function(t,e){var a=this.templates[t];return a=(a=(a=(a=(a=(a=(a=a.replace("[monthly-payment]",e.monthlyPayment)).replace("[apr]",e.apr)).replace("[commission-fee]",e.commissionFee)).replace("[admin-fee]",e.adminFee)).replace("[interest-cost]",e.interestCost)).replace("[total-cost]",e.totalCost)).replace("[currency]",this.currency)},this.setSelectedProduct=function(t){this.selectedProduct=t},this.addTranslations=function(a){Object.keys(a).forEach(function(i){Object.keys(e).forEach(function(e){t.addTranslation(e,i,a)})})},this.addTranslation=function(t,a,i){var r=e[t];400==t||"general"==t?Object.keys(r).forEach(function(r){r===a&&e[t][r].push(i[a])}):r[0]===a&&e[t].push(i[a])},this.addCommas=function(t){for(var e=(t+="").split("."),a=e[0],i=e.length>1?"."+e[1]:"",r=/(\d+)(\d{3})/;r.test(a);)a=a.replace(r,"$1 $2");return a+i},this.getCalculatorOptions=function(){var t=this;$.ajax({async:!1,type:"POST",url:this.url,data:{action:"wc_iute_get_params"},dataType:"json",success:function(e){if(e){for(var a in t.debug("Fetched data:"),t.debug(e),"undefined"!=typeof iute_compaign&&e.loanProductParametersResponseList.map(function(t,a){t.customProductId==iute_compaign.hide&&e.loanProductParametersResponseList.splice(a,1)}),t.calculatorParameters=new Object,t.calculatorOptions=void 0!==e.calculatorOptions?e.calculatorOptions:{},e.loanProductParametersResponseList){var i=e.loanProductParametersResponseList[a].customProductId;if(-1==t.disabledCustomProducts.indexOf(i)){var r=t.parseProductSettingsAndAddToCalculationSets(e.loanProductParametersResponseList[a],0);t.addProductTabs(r,a,!0),t.calculatorParameters[r.customProductId]=r}}var n=e.loanProductParametersResponseList[0].customProductId,o=t.calculatorParameters[n];t.setSelectedProduct(n),t.updateView(o),t.calculate(o)}},error:function(e){t.handleErrors(e)}})},this.parseProductSettingsAndAddToCalculationSets=function(t,e){var a={customProductId:t.customProductId,customProductName:t.customProductName,calculateInterestOnlyOnPrincipal:void 0!==t.calculateInterestOnlyOnPrincipal&&t.calculateInterestOnlyOnPrincipal,customerDisclaimer:t.customerDisclaimer,minAmount:t.minAmount,maxAmount:t.maxAmount,minPeriod:t.minPeriod,maxPeriod:t.maxPeriod,amountLimitedPeriodParameters:{}};return a.amountLimitedPeriodParameters[e]=this.parsePeriodSettings(t,0),a},this.parsePeriodSettings=function(t,e){for(var a=e,i={minAmount:t.minAmount,maxAmount:t.maxAmount,minPeriod:t.minPeriod,maxPeriod:t.maxPeriod,periodParameters:{}},r=t.minPeriod;r<=t.maxPeriod;r++){var n={period:r,forReturningCustomerOnly:void 0!==t.forReturningCustomerOnly&&t.forReturningCustomerOnly,customerDisclaimer:t.customerDisclaimer,calculateOnlyForPrincipal:t.calculateInterestOnlyOnPrincipal,interest:t.parameters.INTEREST[a],comm_fee:t.parameters.COMMISSION[a],shop_fee:t.parameters.SHOP_FEE[a],admin_fee:t.parameters.ADMIN_FEE[a],client_commission:t.clientCommission.COMMISSION_FOR_CLIENT[a]};i.periodParameters[r]=n,a++}return i},this.fetchCombinedPeriodsForCalculatorParameters=function(t){var e=[];for(var a in t.amountLimitedPeriodParameters){var i=t.amountLimitedPeriodParameters[a];for(var r in i.periodParameters){var n=i.periodParameters[r];-1==e.indexOf(n.period)&&e.push(n.period)}}return e},this.findAmountLimitedPeriodParameterSets=function(t){var e=[],a=this.getCurrentAmountSelectionValue(),i=this.getCurrentPeriodSelectionValue();for(var r in t){var n=t[r];$(".iute-calc-single").length&&(n.minAmount=0),a>=n.minAmount&&a<=n.maxAmount&&i>=n.minPeriod&&i<=n.maxPeriod&&(this.debug("Found period parameter set for amount: "+a),e.push(n))}return e},this.findPeriodParameterSet=function(t,e){for(var a in t)if(void 0!==t[a].periodParameters[e])return t[a].periodParameters[e];return null},this.getCombinedParameterSets=function(t){var e={};for(var a in t)for(var i in t[a].periodParameters){var r=t[a].periodParameters[i];e[i]||(e[i]=r)}return e},this.getVisibleTabPeriods=function(t){var e=[];for(var a in t){var i=t.length,r=Math.ceil(i/10);i>10&&a%r>0||e.push(t[a])}return e},this.calculateLoanConditions=function(t){this.debug("Calculating conditions...");var e=this.calcExtras(t);this.debug("Total extra cost: "+e),t.extraFee+=e;var a=this.monthlyPayment(t);this.debug("Monthly payment: "+a);var r=i(a,t),n=this.calcApr(t,a),o=this.calculateXIRR(t,r,a),s={loanAmount:t.amount.toFixed(2),loanPeriod:t.numPayments,monthlyPayment:a.toFixed(2),commissionFee:t.clientCommissionAmount.toFixed(2),adminFee:t.adminFeeAmount.toFixed(2),interestCost:Math.abs(r-t.amount-t.adminFeeAmount-t.clientCommissionAmount).toFixed(2),totalCost:r.toFixed(2),apr:n,xirr:o.toFixed(2),forReturningCustomerOnly:t.forReturningCustomerOnly,customerDisclaimer:t.customerDisclaimer};return this.debug("Finished calculating conditions"),s};var i=function(t,e){return 0===e.interestRate?e.amount+e.extraFee+e.adminFeeAmount:t.toFixed(2)*e.numPayments};this.calculateForSelected=function(){return null==this.selectedProduct?void console.log("No calculation parameters."):this.calculate(this.calculatorParameters[this.selectedProduct])},this.calculateForProduct=function(t){var e=this.calculatorParameters[t];this.updateView(e),this.calculate(e)},this.calculate=function(t){this.debug("Calculating..."),$(".period-monthly-payment").text("");var e=this.findAmountLimitedPeriodParameterSets(t.amountLimitedPeriodParameters),a=this.findPeriodParameterSet(e,this.getCurrentPeriodSelectionValue());if(a){this.hideError();var i=this.calculateForPeriod(a);this.debug("Calculated results for period: "+this.getCurrentPeriodSelectionValue()),this.debug("Calculating results for all other periods..."),this.calculateLoanConditionsForAllPeriods(t),this.debug("Finished calculations"),this.updateResultsView(i),this.debug("Finished updating view")}else this.showErrorForLabel("invalid.period.or.loan.amount")},this.calculateLoanConditionsForAllPeriods=function(t){var e=this.getCombinedParameterSets(t.amountLimitedPeriodParameters),a=this.fetchCombinedPeriodsForCalculatorParameters(t),i=this.getVisibleTabPeriods(a);for(var r in i){var n=e[i[r]],o=this.calculateForPeriod(n);$("#period-monthly-payment-"+t.customProductId+"-"+n.period).text(this.processTemplate("PERIOD_INFORMATION_TEMPLATE",o))}},this.calculateForPeriod=function(t){var e=this.getCurrentAmountSelectionValue(),a=t.comm_fee,i=t.shop_fee,r=t.admin_fee,n=t.interest,o=t.client_commission,s=a/100,u=r/100,c=e*(i/100),l=o?e*s:e*s-c,m={amount:e,numPayments:t.period,interestRate:parseFloat(n),commissionRate:s,commissionAmount:e*s,clientCommissionAmount:l,commissionPaidByClient:o,adminRate:u,adminFeeAmount:e*u*t.period,shopFeeAmount:c,extraFee:0,compoundFrequency:void 0!==this.calculatorOptions.compoundFrequency?this.calculatorOptions.compoundFrequency:12,paymentFrequency:12,calculateOnlyForPrincipal:t.calculateOnlyForPrincipal,forReturningCustomerOnly:t.forReturningCustomerOnly,customerDisclaimer:t.customerDisclaimer};return this.debug("Calculating for values:"),this.debug(m),this.calculateLoanConditions(m)},this.monthlyPayment=function(t){this.debug("Calculating monthly payment...");var e=Math.pow(1+t.interestRate/100/t.compoundFrequency,t.compoundFrequency/t.paymentFrequency)-1;this.debug("r="+e);var a=0;e>0?(a=(t.amount+t.extraFee)*e*Math.pow(1+e,t.numPayments)/(Math.pow(1+e,t.numPayments)-1),this.debug("Result for r > 0: "+a)):(a=(t.amount+t.extraFee)/t.numPayments,this.debug("Result for r <= 0: "+a));var i=t.adminFeeAmount/t.numPayments;if(this.debug("Admin fee monthly: "+i),t.calculateOnlyForPrincipal){var r=t.clientCommissionAmount/t.numPayments;this.debug("Client commission monthly: "+r),a+=r}a+=i;var n=Math.round(1e6*a)/1e6;return this.debug("Calculated total monthly payment: "+n),this.debug("Finished calculating monthly payment"),n},this.calcApr=function(t,e){this.debug("Calculating APR..."),this.debug(t),this.debug("Monthly payment for APR: "+e);var a=Math.round(1e6*e)/1e6;this.debug("Rounded monthly payment for APR: "+a);var i=a/t.amount;if(this.debug("Initial diff: "+i),0==t.extraFee&&0==t.adminFeeAmount&&0==t.interestRate)return this.debug("No extra fees nor interest. Not calculating APR."),0;var r=.05,n=0,o=1;do{this.debug("Iteration start: "+o);var s=r*Math.pow(1+r,t.numPayments);this.debug("fx = "+s);var u=Math.pow(1+r,t.numPayments)-1;this.debug("dx = "+u),n=s/u-i,this.debug("z = "+n),r-=n,this.debug("a = "+r),this.debug("Iteration end: "+o),o++}while(Math.abs(n)>1e-9);var c=100*t.compoundFrequency*(Math.pow(r+1,t.paymentFrequency/t.compoundFrequency)-1);this.debug("APR percentile: "+c);var l=Math.round(100*c)/100;return this.debug("Calculated APR: "+l),this.debug("Finished APR calculations"),l},this.calcExtras=function(t){var e=0;return t.calculateOnlyForPrincipal||(e+=t.clientCommissionAmount),Math.round(100*e)/100},this.calculateNetPresentValue=function(t,e){var a=0,i=e[0].date;for(var r in e){var n=e[r];a+=n.cashFlow/Math.pow(1+t,this.daysBetween(i,n.date)/365)}return a},this.prepareTransactions=function(t,e,a){this.debug("Preparing transactions for XIRR");var i=t.amount;this.debug("Principal amount: "+i);var r=new Object,n=new Date;r[0]={cashFlow:-Math.abs(i),date:n},this.debug("Added initial transaction: "),this.debug(r[0]);var o=e;this.debug("Initial payback reminder: "+o);for(var s=1;s<=t.numPayments;s++){this.debug("Preparing transaction: "+s);var u=new Date(n);u.setMonth(u.getMonth()+s);var c=s==t.numPayments?o.toFixed(2):a;r[s]={cashFlow:Math.abs(c),date:u},this.debug(r[s]),o=Math.round(100*(o-c))/100,this.debug("PaybackReminder: "+o)}return r},this.calculateXIRR=function(t,e,a){this.debug("Initial monthly payment fro XIRR: "+a);var i=Math.floor(100*a)/100;this.debug("Floored monthly payment for XIRR: "+i);var r=this.prepareTransactions(t,e,i),n=0,o=.01,s=this.calculateNetPresentValue(n,r),u=this.calculateNetPresentValue(o,r);do{Math.abs(s)<Math.abs(u)?s=this.calculateNetPresentValue(n+=1.6*(n-o),r):u=this.calculateNetPresentValue(o+=1.6*(o-n),r)}while(s*u>=0);var c=this.calculateNetPresentValue(n,r),l=c<0?n:o,m=c<0?o-n:n-o;do{var d=l+(m*=.5),h=this.calculateNetPresentValue(d,r);h<=0&&(l=d)}while(Math.abs(h)>=1e-6&&Math.abs(m)>=1e-6);return Math.round(1e4*d)/100},this.getCurrentPeriodSelectionValue=function(){let t=$(".iute-calc-single-range");return t.length?(console.log(t.val()),parseInt(t.val())):parseInt($("#months").val())},this.getCurrentAmountSelectionValue=function(){return parseFloat($("#amount").val())},this.updateResultsView=function(t){$("#loanAmount").html(this.addCommas(t.loanAmount)+" "+this.currency),$("#loanPeriod").html(t.loanPeriod),$("#newCustomer").prop("checked",!t.forReturningCustomerOnly),$("#returningCustomer").prop("checked",t.forReturningCustomerOnly),$("#customerDisclaimer").html(t.customerDisclaimer),$("#monthlyPayment").html(this.addCommas(t.monthlyPayment)+" "+this.currency),$("#commissionFee").html(this.addCommas(t.commissionFee)+" "+this.currency),$("#adminFee").html(this.addCommas(t.adminFee)+" "+this.currency),$("#interestCost").html(this.addCommas(t.interestCost)+" "+this.currency),$("#totalCost").html(this.addCommas(t.totalCost)+" "+this.currency),$("#apr").html(t.apr),$("#xirr").html(t.xirr);let e=$(".iute-calc-single-range");e.length&&($(".iute-calc-single time span").text(e.val()),$(".iute-loan__price label").text(this.addCommas(t.monthlyPayment)))},this.updateView=function(t){$("#rangeInput").attr({min:t.minAmount,max:t.maxAmount}),$("#amount").attr({min:t.minAmount,max:t.maxAmount});var e=$("#amount").val();void 0===e||0==e?($("#amount").val(t.minAmount),$("#rangeInput").val(t.minAmount)):($("#amount").val(e),$("#rangeInput").val(e)),$("#periodInput").attr({min:t.minPeriod,max:t.maxPeriod}),$(".iute-calc-single-range").attr({min:t.minPeriod,max:t.maxPeriod}),$("#months").attr({min:t.minPeriod,max:t.maxPeriod});var a=$("#months").val();void 0===a||0==a||a<t.minPeriod?($("#months").val(t.minPeriod),$("#periodInput").val(t.minPeriod)):($("#months").val(a),$("#periodInput").val(a))},$("#amount").change(function(){$("#rangeInput").val($("#amount").val()),t.calculateForSelected()}),$("#rangeInput").on("input",function(){$("#amount").val($("#rangeInput").val()),t.calculateForSelected()}),$(document).delegate("#months","change",function(){$("#periodInput").val($("#months").val()),t.calculateForSelected()}),$(document).delegate("#periodInput","input",function(){$("#months").val($("#periodInput").val()),t.calculateForSelected()}),$(document).delegate("#nav-tab .nav-item","click",function(e){$(".nav-item").each(function(){$(this).removeClass("active"),$(this).attr("aria-selected","false")}),$(".tab-pane").each(function(){$(this).removeClass("active"),$(this).removeClass("show")}),$(this).addClass("active"),$(this).attr("aria-selected","true");var a=Number(e.target.id.split("-")[2]);$("#product-"+a).addClass("active"),$("#product-"+a).addClass("show"),$('input[name="iute_appl_pr_id"]').val(a),t.setSelectedProduct(a),t.calculateForProduct(a)}),$(document).delegate("#nav-tabContent .list-group-item","click",function(){var e=$(this).get(0).id;$("#months").val(e),$("#periodInput").val(e),t.calculateForSelected()}),this.addProductTabs=function(e,a,i){var r=0==a?"true":"false",n=0==a?"active":"";i&&$("#nav-tab").append($('<a class="nav-item nav-link '+n+'" id="product-tab-'+e.customProductId+'"data-toggle="tab" href="#product-'+e.customProductId+'" role="tab" aria-selected="'+r+'">'+e.customProductName+"</a>")),$("#nav-tabContent").append($('<div class="tab-pane fade show '+n+'" id="product-'+e.customProductId+'" role="tabpanel" aria-labelledby="product-tab-'+e.customProductId+'">'+t.addTabContent(e)+"</div>")),$('input[name="iute_appl_pr_id"]').length&&($('input[name="iute_appl_pr_id"]').val()||$('input[name="iute_appl_pr_id"]').val(e.customProductId))},this.addTabContent=function(t){var e=this.fetchCombinedPeriodsForCalculatorParameters(t),a='<div id="product-period-content" class="list-group list-group-horizontal">',i=this.getVisibleTabPeriods(e);for(var r in i)a+='<div id="'+i[r]+'" class="list-group-item list-group-item-action">',a+='<div class="row justify-content-center"><h3>'+i[r]+"</h3></div>",a+='<div id="period-monthly-payment-'+t.customProductId+"-"+i[r]+'" class="row justify-content-center period-monthly-payment" style="font-size: 12px;"></div>',a+="</div>";return a+="</div>",a+="Select period in months"}};!function(t){t(document).ready(function(){t(".iute-calculator").length&&(setTimeout(function(){(e=new EshopCalculator).initWithLiveAgentInformation(iute_params.country,iute_params.currency,iute_params.api_url,iute_params.agent_id,[])},1e3),t(document).on("ajaxComplete",function(t,a,i){"/?wc-ajax=update_order_review"===i.url&&"object"==typeof e&&e.initWithLiveAgentInformation(iute_params.country,iute_params.currency,iute_params.api_url,iute_params.agent_id,[])}));if(t(".single-product").length){var e,a=(e=new EshopCalculator).fetchInputParameters(iute_params.country,iute_params.currency,iute_params.api_url,iute_params.agent_id);e.parseProductSettingsAndAddToCalculationSets(a.loanProductParametersResponseList[0],0);function i(e){result="";var a=parseFloat(t("#amount").val());return t.ajax({async:!1,type:"POST",url:iute_params.api_url,data:{action:"wc_iute_get_param",amount:a},dataType:"json",success:function(t){t&&(result=t.monthlyRepayments.find(t=>t.period===e).monthlyRepayment)},error:function(t){console.log(t)}}),result}e.initWithLiveAgentInformation(iute_params.country,iute_params.currency,iute_params.api_url,iute_params.agent_id,[]),t(".iute-loan__price label").text(i(a.loanProductParametersResponseList[0].maxPeriod)),t(".iute-calc-single-range").change(function(){if("yes"==iute_params.use_api)t(".iute-calc-single time span").text(t(this).val()),t(".iute-loan__price label").text(i(t(this).val()));else{let t=a.loanProductParametersResponseList[0].customProductId;e.setSelectedProduct(t),e.calculateForProduct(t)}})}})}(jQuery);